'use strict';
var qtools = require('qtools');
qtools=new qtools(this);

var schoolFieldList = ["District", "District Type", "School Code", "School Name", "SchoolMinimumGrade", "SchoolMaximumGrade", "SchoolLevelName", "SchoolAreaName", "SuperintendentLastName", "SuperintendentFirstName", "SuperintendentMiddleName", "AreaSuperintendentLastName", "AreaSuperintendentFirstName", "AreaSuperintendentMiddleName", "PrincipalLastName", "PrincipalFirstName", "PrincipalMiddleName", "SchoolPrimaryPhone", "SchoolAlternatePhone", "SchoolFaxNumber", "AddressLine1", "AddressLine2", "AddressLine3", "City Name", "CountyName", "StateCode", "StateName", "ZipCode"]
var termFieldList = ["SchoolYear", "SchoolNumber", "Term Description", "StartDate", "EndDate", "TermType", "Term Number"];

var synthSeq = 0;
var syntheticSequenceNumber = function(itemObj, sourceItem) {
	return synthSeq++;
}

var teacherUffFieldList = ["DistrictCode", "Filler2", "StaffUniqueIdentifier",
	"SchoolYearBeg", "SchoolYearEnd", "EmployeeID",
	"LocalStaffCode", "State School/PlantNumber",
	"LastName", "MiddleName", "FirstName", "FullName",
	"JobCode1", "JobCode2", "JobCode3", "JobCode4", "Phone",
	"Email", "Department1", "Department2", "Department3",
	"Department4", "Status", "PrimaryLocationFlag", "Login Name",
	"Password", "Default Password"];

var homeroomUffFieldList = ["DistrictCode", "DistrictType", "SchoolCode",
	"SectionNumber", "CourseNumber", "TermAbbrev",
	"SchoolYearBeg", "SchoolYearEnd", "Grade", "BeginDate",
	"EndDate", "Location", "HomeroomFlag", "BegPeriodNum",
	"EndPeriodNum", "Credit", "TeamCode", "Track"];
var assignStudentUffFieldList = ["DistrictCode", "DistrictType", "SchoolCode",
	"StudentUniqueIdentifier", "StateStudentNumber",
	"LocalStudentNumber", "SchoolYearBeg", "SchoolYearEnd",
	"SectionNumber", "CourseNumber", "GradeLevel",
	"EntryDate", "WithdrawalDate", "EntryType",
	"Withdrawaltype"];
var assignTeacherUffFieldList = ["DistrictCode", "DistrictType", "SchoolCode",
	"StaffUniqueIdentifier", "LocalStaffCode",
	"SchoolYearBeg", "SchoolYearEnd", "SectionNumber",
	"CourseNumber", "Grade", "PrimaryInstructorFlag",
	"LastName", "MiddleName", "FirstName"];
var studentUffFieldList = ["DistrictCode", "DistrictType", "SchoolCode",
	"SchoolYearBegin", "SchoolYearEnd",
	"StudentUniqueIdentifier", "StateStudentNumber",
	"LocalStudentNumber", "GradeLevel", "Graduation Year",
	"Student Status", "LastName", "MiddleName", "FirstName",
	"Suffix", "Prefix", "FullName", "PreferredName",
	"LastSchoolAttended", "Concurrent Enrollment",
	"BirthDate", "Self Guardian Flag", "Gender", "SSN",
	"BirthPlace", "BirthState", "BirthCountry",
	"EthnicityCode"];
var gradeLevelUffFieldList = ["SchoolID",
	"Grade",
	"Grade Description",
	"School Year Begin",
	"School Year End"];


var Address_Contact_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "StaffUniqueIdentifier", "SchoolCode", "AddressTypeCode", "Address1", "Address2", "Address3", "City", "StateName", "StateCode", "ZipCode", "CountyCode", "CountyName", "ContactCode", "ContactLegalCode", "ContactExtraMailingCode", "ContactSequence#", "ContactFirstName", "ContactMiddleName", "ContactLastName", "ContanctFullName", "ContactPhone1", "ContactPhone2", "ContactPhone3", "Phone1Type", "Phone2Type", "Phone3Type", "ContactEMail"];
var Course_File_FieldList = ["DistrictCode", "DistrictType", "SchoolCode", "CourseNumber", "SchoolYearBeg", "SchoolYearEnd", "CourseDesc", "CourseAbbrev", "SubjectArea/Department", "Credit", "GradeMinimum", "GradeMaximum"];
var User_Base_File_FieldList = ["DistrictCode", "Filler2", "StaffUniqueIdentifier", "SchoolYearBeg", "SchoolYearEnd", "EmployeeID", "LocalStaffCode", "State School/PlantNumber", "LastName", "MiddleName", "FirstName", "FullName", "JobCode1", "JobCode2", "JobCode3", "JobCode4", "Phone", "Email", "Department1", "Department2", "Department3", "Department4", "Status", "PrimaryLocationFlag", "Login Name", "Password", "Default Password"];
var Lookups_FieldList = [];
var Section_File_FieldList = ["DistrictCode", "DistrictType", "SchoolCode", "SectionNumber", "CourseNumber", "TermAbbrev", "SchoolYearBeg", "SchoolYearEnd", "Grade", "BeginDate", "EndDate", "Location", "HomeroomFlag", "BegPeriodNum", "EndPeriodNum", "Credit", "TeamCode", "Track"];
var Section_Staff_File_FieldList = ["DistrictCode", "DistrictType", "SchoolCode", "StaffUniqueIdentifier", "LocalStaffCode", "SchoolYearBeg", "SchoolYearEnd", "SectionNumber", "CourseNumber", "Grade", "PrimaryInstructorFlag", "LastName", "MiddleName", "FirstName"];
var Section_Student_File_FieldList = ["DistrictCode", "DistrictType", "SchoolCode", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "SchoolYearBeg", "SchoolYearEnd", "SectionNumber", "CourseNumber", "GradeLevel", "EntryDate", "WithdrawalDate", "EntryType", "Withdrawaltype"];
var StudentBaseTest2_FieldList = [];
var Student_Attendance_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "SchoolYearBeg", "SchoolYearEnd", "SchoolCode", "Attendance Time Unit", "Term Abbrev", "Attendance Category", "Attendance Type", "AttendanceCode", "AttendanceDate", "PeriodCode", "TimeIn", "TimeOut", "Note"];
var Student_Base_File_FieldList = ["DistrictCode", "DistrictType", "SchoolCode", "SchoolYearBegin", "SchoolYearEnd", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "GradeLevel", "Graduation Year", "Student Status", "LastName", "MiddleName", "FirstName", "Suffix", "Prefix", "FullName", "PreferredName", "LastSchoolAttended", "Concurrent Enrollment", "BirthDate", "Self Guardian Flag", "Gender", "SSN", "BirthPlace", "BirthState", "BirthCountry", "EthnicityCode"];
var Student_Discipline_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "SchoolYearBeg", "SchoolYearEnd", "SchoolCode", "Discipline Time Unit", "Term Abbrev", "Discipline Category", "DisciplineCode", "DisciplineDate", "DispositionCode", "DispositionBeginDate", "DispositionEndDate", "Note"];

var Student_Enrollment_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "SchoolCode", "SchoolYearBeg", "SchoolYearEnd", "GradeLevel", "EntryDate", "WithdrawalDate", "EntryTypeCode", "WithdrawalTypeCode", "StudentResidentDistrictCode", "StudentResidentDIstrictType", "StudentResidentSchoolCode", "StateAidCategory", "LastLocationofAttendance", "PercentEnrolled", "AttendanceDays", "MembershipDays", "PostSecondaryOption", "PSEOHighSchoolParticipationHrs  ", "HomeBoundServiceIndicator", "SpecialEducationEvaluationStatus", "SpecialEdInstructionalSetting", "LEP", "LEPBeginDate", "Gifted&TalentedPartiicipation", "Gender", "EthnicityCode", "BirthDate", "HomePrimaryLanguage", "PrimaryDisability", "TransportationCategory", "EconomicIndicator", "MigrantIndicator", "StudentTitle1Indicator", "HomelessStudentFlag", "TransportingDistrictCode", "TransportingDistrictType", "WardofStateFlag", "IndependentStudyFlag", "SupplementalEducationServices", "SpecialEnrollmentCode", "PrimarySchoolFlag", "SpecEd Flag", "504 Flag", "Track", "TeamCode", "Promotion Status", "Program of Study", "Enrollment Status", "Filler", "Filler ", "Filler", "Filler", "Filler", "Filler", "AdvisorID/Name", "Filler", "ELLServiceLevel", "Hispanic-Latino", "American Indian Alaska Native", "Asian", "Black-African American", "Native Hawaiian-Pacific Islander", "White", "First US School Entry Date", "New to Country Flag", "Filler ", "Next Year School"];

var Student_GPA_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "CreditsEarned", "SchoolYearBegin", "SchoolYearEnd", "GPA1", "GPA2", "SchoolLevelName", "Program of Study"];
var Student_Grades_File_FieldList = ["DistrictCode", "DistrictType", "StudentUniqueIdentifier", "StateStudentNumber", "LocalStudentNumber", "CourseCode", "TermCode", "SubjectArea/Department", "GradeLevel", "CreditsEarned", "CreditsAttempted", "GradeMark", "SchoolYearBegin", "SchoolYearEnd", "SchoolCode", "CourseDesc", "SectionNumber", "TeacherName"];

var passThroughDefinition = function(fieldList) {
	var list = [],
		outObj = {};
	for (var i = 0, len = fieldList.length; i < len; i++) {
		var element = fieldList[i];//.toCamelCase(' ', true);
		outObj[element] = element;
	}
	return outObj;
}



	var processForStudents = function(sqlizer) {

		sqlizer.removeDupes('Student_Base');

		sqlizer.setBaseTable('Student_Base');


		sqlizer.index('Address_Contact', 'StudentUniqueIdentifier');
		sqlizer.index('Student_Enrollment', 'StudentUniqueIdentifier');

		sqlizer.leftJoin('StudentUniqueIdentifier', 'Address_Contact', 'StudentUniqueIdentifier');
		sqlizer.leftJoin('StudentUniqueIdentifier', 'Student_Enrollment', 'StudentUniqueIdentifier');

		sqlizer.mapColumns({
			"Student_Enrollment.Expr1": function(record) {
				var value = record.Student_Enrollment.StudentResidentSchoolCode;

				if (value == '000') {
					value = "";
				}

				return value;
			}
		});



		var bethSelector = function(record) {
			var selected = (

			(record.Address_Contact && (record.Address_Contact.AddressTypeCode.toLowerCase() == "primary1"
			|| record.Address_Contact.AddressTypeCode == ''))

			&& (record.Student_Enrollment && record.Student_Enrollment['Enrollment Status'].toLowerCase() == "a")

			)
			return selected;

		};

		sqlizer.select(bethSelector)

		var result = sqlizer.getResult();




		return result;
	}

module.exports = {


	//NOTE: maps property are "sourceFileFieldName":"targetJsonPropertyName". Empty map, {}, emits entire fieldlist.
	//ALSO: translations are executed *after* maps are set. Their format is: "targetJsonPropertyName": function
	//Translations are 1) the only way to use a source field twice, and
	//2) the only way to *create* a field that does not map to a source field
	//return '<!omitProperty!>'; will remove the property entirely

	//[doc1] - MN SIS Extract Files - Unified_V9(In Progress)
	//[doc2] - Plans4.x Import File Formats
	//[doc3] - DWextractLayout




	"teacher": //[doc1-User Base File]
	{
		"schemaName": "UserBase",
		"fieldList": teacherUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(teacherUffFieldList)
		},

		"translation": {
			"expressbook": {
				"Active": function(itemObj, sourceItem) {
					if (sourceItem.Status === 'A') {
						return 1;
					} else {
						return 0;
					}
				},

				"LDAP": function(itemObj, sourceItem) {
					return 0;
				},

				"UserName": function(itemObj, sourceItem) {
					if (sourceItem["Login Name"]) {
						return sourceItem["Login Name"];
					} else {
						return sourceItem["EmployeeID"];
					}
				},

				"Password": function(itemObj, sourceItem) {
					if (sourceItem["Login Name"]) {
						return sourceItem["Password"];
					} else {
						return 'test';
					}
				}
			}
		}
	},

	"Dual_Lookup": {
		componentSchemaList: [
			"Student_Base",
			"Address_Contact",
			"Student_Enrollment"
		],
		"assembler": {
			"expressbook": {
				name: 'pseudoSql', //note: this refers to an assembler in the dataAccess module package. Could refer to a fully qualified path to an assembler elsewhere.
				params: {finalProcess:processForStudents}
			}
		}
	},

	"Address_Contact":
	{
		unfinished: true,
		"schemaName": "Address_Contact_File",
		fileName: "Address_Contact_File",
		"fieldList": Address_Contact_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Address_Contact_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},

	"Course":
	{
		unfinished: true,
		"schemaName": "Course_File",
		fileName: "Course_File",
		"fieldList": Course_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Course_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"User_Base":
	{
		unfinished: true,
		"schemaName": "User_Base_File",
		fileName: "User_Base_File",
		"fieldList": User_Base_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(User_Base_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Lookups":
	{
		unfinished: true,
		"schemaName": "Lookups",
		fileName: "Lookups",
		"fieldList": Lookups_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Lookups_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Section":
	{
		"schemaName": "Section_File",
		fileName: "Section_File",
		"fieldList": homeroomUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(homeroomUffFieldList)
		},

		"translation": {
			"expressbook": {}
		}
	},




	"Section_Staff":
	{
		"schemaName": "Section_Staff_File",
		fileName: "Section_Staff_File",
		"fieldList": assignTeacherUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(assignTeacherUffFieldList)
		},
		"translation": {
			"expressbook": {
			}
		}
	},




	"Section_Student":
	{
		"schemaName": "Section_Student_File",
		fileName: "Section_Student_File",
		"fieldList": assignStudentUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(assignStudentUffFieldList)
		},
		"translation": {
			"expressbook": {
			}
		}
	},




	"StudentBaseTest2":
	{
		"schemaName": "StudentBase",
		"fileName": "StudentBaseTest2",
		"fieldList": studentUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(studentUffFieldList)
		},
		"translation": {
			"expressbook": {
			}
		}
	},




	"Student_Attendance":
	{
		unfinished: true,
		"schemaName": "Student_Attendance_File",
		fileName: "Student_Attendance_File",
		"fieldList": Student_Attendance_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Student_Attendance_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Student_Base":
	{
		"schemaName": "Student_Base_File",
		"fileName": "Student_Base_File",
		"fieldList": studentUffFieldList,
		"maps": {
			"expressbook": passThroughDefinition(studentUffFieldList)
		},
		"translation": {
			"expressbook": {
			}
		}
	},




	"Student_Discipline":
	{
		unfinished: true,
		"schemaName": "Student_Discipline_File",
		fileName: "Student_Discipline_File",
		"fieldList": Student_Discipline_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Student_Discipline_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Student_Enrollment":
	{
		unfinished: true,
		"schemaName": "Student_Enrollment_File",
		fileName: "Student_Enrollment_File",
		"fieldList": Student_Enrollment_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Student_Enrollment_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Student_GPA":
	{
		unfinished: true,
		"schemaName": "Student_GPA_File",
		fileName: "Student_GPA_File",
		"fieldList": Student_GPA_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Student_GPA_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	},




	"Student_Grades":
	{
		unfinished: true,
		"schemaName": "Student_Grades_File",
		fileName: "Student_Grades_File",
		"fieldList": Student_Grades_File_FieldList,
		"maps": {
			"expressbook": passThroughDefinition(Student_Grades_File_FieldList)
		},
		"translation": {
			"expressbook": {}
		}
	}
};


