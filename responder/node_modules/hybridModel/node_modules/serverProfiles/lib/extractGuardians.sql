if exists (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' and TABLE_NAME='ExContactGuardians' and TABLE_SCHEMA='ext')
DROP TABLE ext.ExContactGuardians;
go

DECLARE @withdrawalSchoolYear nvarchar(4)
SET @withdrawalSchoolYear='2015';

SELECT DISTINCT
      '' AS DistrictCode,
      '' AS DistrictType,
      s.[STUDENT-ID]  AS StudentCode,
      s.[MN-EDE-NBR] AS MARSSID,
      s.[STUDENT-ID] AS LocalStudentNumber,
      '' AS UniqueStaffCode, 
      sew.[ENTITY-ID] AS schoolCode, 
      CASE
        WHEN a.[POBOX]<>'' THEN 'RM'
        ELSE 'R'
      END AS AddressTypeCode,
      CASE
        WHEN a.[POBOX]<>'' THEN 'PO BOX ' + a.[POBOX]
        ELSE
          LTRIM(a.[STREET-NUMBER]+' '+a.[STREET-NAME])
      END AS Address1, 
      '' AS Address2, 
      '' AS Address3, 
      z.[ZIP-CITY] AS City, 
      z.[ZIP-STATE] AS StateName,
      z.[ZIP-STATE] AS StateCode, 
      a.[ZIP-CODE] AS ZipCode, 
      '' AS CountyCode, 
      '' AS CountyName, 
      '' AS ContactCode, 
      'L' AS ContactLegalCode,
      '' AS ContactExtraMailingCode, 
      '' AS ContactSequence, 
      
      gn.[FIRST-NAME] AS ContactFirstName, 
      gn.[MIDDLE-NAME] AS ContactMiddleName, 
      gn.[LAST-NAME] AS ContactLastName, 
      
      gn.[FIRST-NAME] + ' ' + gn.[MIDDLE-NAME] + ' ' + gn.[LAST-NAME] AS ContactFullName, 
      gn.[PRIMARY-PHONE] AS ContactPhone1, 
      gn.[SECOND-PHONE] AS ContactPhone2, 
      gn.[THIRD-PHONE] AS ContactPhone3, 
      'PARENT' AS Phone1Type, 
      gn.[SECOND-PHONE-TYPE] AS Phone2Type,
      gn.[THIRD-PHONE-TYPE] AS Phone3Type, 
      gn.[INTERNET-ADDRESS] AS ContactEMail,
      -- columns appended to the end to make later decisions
      s.[STUDENT-ID],
      gn.[NAME-ID],
      gn.[NALPHAKEY],
      s.[ALPHAKEY],
      s.[OTHER-ID],
      a.[STREET-APPT],
      sew.[ENTITY-ID],
      sew.[SCHOOL-ID]
INTO  ext.ExContactGuardians
FROM     sky.[STUDENT-EW] AS sew
        INNER JOIN (SELECT [STUDENT-ID], [ENTITY-ID], MAX([EW-DATE]) AS [EW-DATE]
                    FROM sky.[STUDENT-EW] 
                    WHERE [WITHDRAWAL-SCHOOL-YEAR] IN (@withdrawalSchoolYear)
                    GROUP BY [STUDENT-ID], [ENTITY-ID]
                   ) AS sew1 ON sew1.[STUDENT-ID] = sew.[STUDENT-ID] AND
                                sew1.[EW-DATE] = sew.[EW-DATE] AND
                                sew1.[ENTITY-ID] = sew.[ENTITY-ID]
        INNER JOIN sky.[STUDENT] AS s ON s.[STUDENT-ID] = sew.[STUDENT-ID]
        
        INNER JOIN sky.[NAME] AS n ON n.[NAME-ID] = s.[NAME-ID]
        
        INNER JOIN (SELECT sew.[STUDENT-ID], [ENTITY-ID], MAX(sew.[WITHDRAWAL-DATE]) AS [WITHDRAWAL-DATE]
                    FROM sky.[STUDENT-EW] AS sew
                    WHERE sew.[WITHDRAWAL-SCHOOL-YEAR] IN (@withdrawalSchoolYear)
                    GROUP BY sew.[STUDENT-ID], [ENTITY-ID]
                   ) AS t1 ON t1.[STUDENT-ID] = sew.[STUDENT-ID] AND
                              t1.[ENTITY-ID] = sew.[ENTITY-ID]
        LEFT JOIN (SELECT DISTINCT se.[STUDENT-ID], se.[ENTITY-ID], se.[STUDENT-STATUS]
                   FROM sky.[STUDENT-ENTITY] AS se
                   WHERE se.[X-DEFAULT-ENTITY] = 1 OR
                         se.[STUDENT-STATUS] <> 'A'
                  ) AS se ON se.[STUDENT-ID] = sew.[STUDENT-ID] AND
                             se.[ENTITY-ID] = sew.[ENTITY-ID]
        LEFT JOIN sky.[ADDRESS] AS a ON a.[ADDRESS-ID] = n.[ADDRESS-ID]
        LEFT JOIN sky.[ZIP] AS z ON z.[ZIP-CODE] = a.[ZIP-CODE]
        
        left join sky.[STUDENT-FAMILY] as sf on sf.[STUDENT-ID]=s.[STUDENT-ID]
		left join sky.[FAMILY-GUARDIAN] as fg on fg.[FAMILY-ID]=sf.[FAMILY-ID]
		left join sky.NAME as gn on gn.[NAME-ID]=fg.[NAME-ID]
        
        
        
WHERE     sew.[WITHDRAWAL-SCHOOL-YEAR] IN (@withdrawalSchoolYear);

INSERT INTO LP.Address_Contact
(
districtCode,
districtType,
studentUniqueIdentifier,
marssId,
localStudentIdentifier,
staffUniqueIdentifier,
schoolCode,
addressTypeCode,
address1,
address2,
address3,
city,
stateName,
stateCode,
zipCode,
countyCode,
contactCode,
contactLegalCode,
contactExtraMailingCode,
contactSequence,
contactFirstName,
contactMiddleName,
contactLastName,
contactFullName,
contactPhone1,
contactPhone2,
contactPhone3,
phone1Type,
phone2Type,
phone3Type,
contactEmail
)
SELECT
"districtCode" as 'districtCode',
"districtType" as 'districtType',
"StudentCode" as 'studentUniqueIdentifier',
"MARSSID" as 'marssId',
"localStudentNumber" as 'localStudentIdentifier',
"UniqueStaffCode" as 'staffUniqueIdentifier',
"schoolCode" as 'schoolCode',
"AddressTypeCode" as 'addressTypeCode',
"Address1" as 'address1',
"Address2" as 'address2',
"Address3" as 'address3',
"City" as 'city',
"StateName" as 'stateName',
"StateCode" as 'stateCode',
"ZipCode" as 'zipCode',
"CountyCode" as 'countyCode',
"ContactCode" as 'contactCode',
"ContactLegalCode" as 'contactLegalCode',
"ContactExtraMailingCode" as 'contactExtraMailingCode',
"ContactSequence" as 'contactSequence',
"ContactFirstName" as 'contactFirstName',
"ContactMiddleName" as 'contactMiddleName',
"ContactLastName" as 'contactLastName',
"ContactFullName" as 'contactFullName',
"ContactPhone1" as 'contactPhone1',
"ContactPhone2" as 'contactPhone2',
"ContactPhone3" as 'contactPhone3',
"Phone1Type" as 'phone1Type',
"Phone2Type" as 'phone2Type',
"Phone3Type" as 'phone3Type',
"ContactEMail" as 'contactEmail'
FROM ext.ExContactGuardians;